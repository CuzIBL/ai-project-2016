 
recent years have seen a proliferation of embedded systems that combine a digital  discrete  supervisory controller with an analog  continuous  plant. diagnosing faults in such hybrid systems  require techniques that are different from those used for discrete and continuous systems. in addition  these algorithms have to be deployed online to meet the real time requirements of embedded systems. this paper presents a methodology for online tracking and diagnosis of hybrid systems. we demonstrate the effectiveness of the approach with experiments conducted on the fuel transfer system of fighter aircraft. 
1 introduction 
this paper addresses the problem of designing and implementing online monitoring and diagnosis systems for complex systems whose behavior is hybrid  discrete + continuous  in nature. hybrid modeling covers naturally occurring systems  such as cell-cycle control systems in biology. they also capture the behavior of embedded systems that are common in the avionics  automotive  and robotics domains. this wide applicability of hybrid systems has inspired a great deal of research from both control theory and theoretical computer science. 
　we focus on a special class of embedded hybrid systems  characterized by continuous plant dynamics and a discrete supervisory controller. the plant dynamics are defined by continuous state variables associated with the components of the plant. the controller generates actuator signals at discrete time points that can change the plant configuration by turning components on and off  and changing component parameter values and the set points of regulators. therefore  hybrid system models have to seamlessly integrate discrete and continuous behavior analyses using multiple system models. as a result  tasks like monitoring  fault diagnosis  and control require appropriate model selection and switching to be performed online as system behavior evolves. 
　this paper discusses methodologies for the modelbased diagnosis  mbd  of hybrid systems. current techniques in mbd apply well to dynamic systems whose behavior is modeled with discrete event  1  1   or continuous models  1  1 . discrete event approaches to hybrid system diagnosis are based on abstractions of nominal and faulty behavior system behavior into event trajectories. this process may result in loss of information critical for fault isolation and control. our work in continuous diagnosis has demonstrated that behavior transients are the key to quick diagnosis of abrupt faults. it may also be computationally expensive to preenumerate all possible nominal and faulty behavior tra-
jectories. traditional algorithms for continuous diagnosis use a single model that does not accommodate discrete changes. therefore  discrete effects of mode changes have to be modeled by complex continuous non-linear functions that are hard to analyze online in real time. 
　recent work on diagnosis of hybrid systems  1  1  1  has focused on discrete faults  and requires the preenumeration of the model in all modes to perform diagnosis. we present an online model-based diagnosis methodology for parametric faults in hybrid systems that is based on tracking hybrid behaviors  continuous behaviors interspersed with discrete changes   but unlike hybrid automata models  pre-enumeration of all system modes is avoided by generating models at runtime as mode switches occur. 
　the fault isolation task has to take into account possible mode changes during diagnostic analysis. the occurrence of a fault necessarily implies that one no longer has a correct model of system behavior; therefore  mode changes cannot be correctly predicted. to address this  the fault isolation task incorporates a search process  where mode changes may have to be hypothesized and incorporated into the consistency-based diagnosis scheme. the fault isolation process becomes even more complicated if fault detection is delayed  and the diagnosis algorithm has to roll back modes to identify the mode in which the fault occurred. we have developed a generic tracking  fault detection  and fault isolation scheme  which address all of the issues we have outlined above. the rest of the paper presents our hybrid modeling  tracking  and diagnosis scheme for solving the hybrid diagnosis problem. 
1 	unified modeling framework 
1 	diagnosis we use a unified modeling framework called hybrid bond graphs that extends continuous bond graph modeling  

figure 1: fuel system schematic 
to provide compact representations for hybrid models. its component based and hierarchical representation is expressed as topological structures that facilitate causal analysis of system dynamics. it also provides standard techniques for deriving state space and input output equation formulations that are suitable for tracking and estimation tasks . 
1 	bond graphs 
a bond graph  bg  is a domain-independent topological representation that captures energy-based interactions among the different physical processes that make up the system. the vertices in the graph represent subsystems modeled as generic physical processes: capacities  inertias  and dissipators that can have linear and non-linear behaviors. bonds are energy pathways by which subsystems/processes exchange energy in the system. two additional types of vertices  1 and 1 junctions  represent domain independent generalizations of kirchoff s laws and are used as connection points between the sub-systems. there exist systematic techniques to construct the bond graph from the system description . 
1 hybrid bond graphs 
additional mechanisms are introduced into the continuous bg language to include discrete transitions and model switching. we use switched junctions proposed by mosterman and biswas   where each junction in the bond graph may be switched on  activated  and off  deactivated . an activated junction behaves like a conventional bg junction. all the bonds incident on a junction turned off are made inactive  and hence do not play any part in the system dynamics. note that activating or deactivating junctions affect the behavior of adjoining junctions. 
　a finite state automaton  fsa  implements the junction switching function. the fsa may have several states  and each state maps to either the off mode  i.e.  it causes the junction to turn off  or the on mode  i.e.  the 
junction turns on  of the junction. mode transitions defined solely by external controller signals define controlled switching  and those expressed by internal variables crossing boundary values define autonomous switching. for controlled switching the control signal is provided as input to the fsa. for autonomous switching  the function determining the transition condition is provided as input to the fsa. the overall mode of the system is determined by a parallel composition of modes of modes of the individual switched junctions. 
　formally  hybrid bond graphs can be defined as a triple: hbg = {bg  m. a}  where bg is the bond graph model  m = {m1 m1  ...  mkf is a set of finite state of automata  and a is the mapping between each m  and a junction in the bond graph. each m  is a finite state automaton of the type described above  with an output function that maps each state of m  to either on or off. a system mode change is defined by one or more junction automata changing state  and this results in a new bond graph model. 
figure 1 illustrates the fuel transfer system that we use for our experiments. the fuel system is designed to provide an uninterrupted supply of fuel at a constant rate to the aircraft engines  and at the same time to maintain the center of gravity of the aircraft. the system is symmetrically divided into the left and right parts  top and bottom in the schematic . the four supply tanks  left wing  lwt   right wing  rwt   left transfer  ltt   and right transfer  rtt   are full initially. during engine operation  fuel is transferred from the supply tanks to the receiving tanks  left feed  lft  and right feed  rft   based on a pre-defined sequence. the fuel transfer sequence is controlled by valves on pipes at the outlet of the supply tanks and the inlet to the feed tanks. the hybrid bond graph segment for the connection between a wing tank and a feed tank  shown in figure 1  illustrates the component-oriented modeling approach for the hbg. an element called switching implements the finite state automata discussed earlier. the hbg framework also associates one or more parameters with system components. we exploit this in defining a component-based diagnosis methodology  where faults in components are represented as deviations in their parameter values. for example  there are six potential fault candidates in the fuel transfer subsystem in figure 1.  pump  efficiency  wing tank  pipe  switched  and feed . in earlier work  we have shown the equivalence between the hbg framework and the hybrid automata representation . 
1 alternate model representations 
the bond graph can be used to systematically derive alternate model representations. three representations are used to solve different sub-tasks in the diagnosis scheme:  i  state space equations  for tracking of continuous behavior   ii  temporal causal graphs for qualitative fault isolation  and  iii  input output equations  for parameter estimation and refinement of the fault isolation results. a 


diagnosis 	1 

detailed description of temporal causal graphs  tcg  can be found in 1  1  and is not repeated here. essentially the tcg captures causal and temporal relations between variables in the system. the vertices in the graph represent variables of the system and the edges  with labels  represent the types of relations between the variables. 
1 	mbd architecture 
our diagnosis architecture implements a scheme to track the nominal system dynamics using an observer that is robust to model uncertainties and noise in the measurements. it uses a fault detection scheme to trigger the fault isolation scheme when discrepancies are detected between the observed and predicted measurements  tracks and analyzes the fault transients using fault signatures to isolate the fault  and then employs a quantitative parameter estimation scheme to determine the magnitude of the fault. our work focuses on component parameter faults  which are multiplicative  i.e.  faults directly affect the system dynamics models. as discussed earlier  the hybrid nature of the system complicates the tracking and diagnosis tasks  because mode transitions cause model switching  which has to be included in the online behavior tracking and fault isolation algorithms. for pragmatic reasons we simplify our algorithms by making the single fault assumption. 
　we have developed a novel approach that combines qualitative and quantitative algorithms for fault isolation. this extends our earlier work  on fault isolation in continuous systems. the qualitative approach overcomes limitations of quantitative schemes  such as convergence and accuracy problems in dealing with complex nonlinearities and lack of precision of parameter values in system models. it plays a significant role in cutting down on computational complexity  enabling online algorithms for fault isolation in the hybrid framework. the qualitative reasoning scheme is fast and effective  but it has limited discriminatory ability. to uniquely identify the true fault candidate  we employ a quantitative parameter estimation scheme  which also returns the magnitude of the deviated parameter. 
1 	tracking and fault detection 
our hybrid observer is implemented as a combination of an extended kalman filter  ekf  and a hybrid automaton to track continuous behavior in individual modes of operation  and discrete mode changes  controlled and autonomous   respectively. at mode changes  the new state space model and the initial state of the system are recomputed. model uncertainty and measurement noise are implemented as white  uncorrected gaussian distributions with zero mean. the state space model in mode q is defined as: 

where w is distributed n o q  and v is distributed n 1 r   and q and r are process and measurement noise covari-

ance matrices. it is assumed that wk incorporates the  term that captures modeling errors in the system. in our work  the q and r matrices were determined empirically. the extended kalman filter algorithm follows the methodology presented in . 
　mode change calculations are based on the system mode at time step k   and the continuous state of the system  . the discrete controller signals to the plant are assumed known. for controlled transitions  we assume such a signal is input at time step k  and the appropriate mode transition is made at time step k+1 to qk 1. for autonomous transitions  the estimated state vector  xk is used to compute the boolean functions that signal mode transitions. note that several transition functions may be triggered simultaneously. they are combined to derive the new system mode. a mode transition results in a new state equation model  i.e.  the matrices fq  gq  cv  and dh are recalculated online. we have developed an efficient symbolic solver that can construct state equation models from equation fragments. the equation fragments correspond to constituent equations defining component behavior  and the junction relations. when switching occurs  sets of equation fragments are de-activated  and others are activated. the new state equations are then derived incrementally. to simplify analysis  we assume that mode changes and faults occur only after the kalman filter state estimate has converged to its optimal behavior. further details of the observer implementation are presented in . 
　fault detection is performed by first computing estimates of the output variables yk from the state estimates 
xk. we then compute a smoothed estimate yk using an fir filter. finally we compute the residual  yk-ok   where ok are the observations at time step k. if this residual rk is above a threshold e for a pre-defined number of time steps  then a fault is signaled. 
1 	fault isolation and identification 
once a fault has been detected  fault isolation and identification is performed to uniquely isolate the fault and determine its magnitude. our fault isolation and identification architecture is presented in figure 1 involves three steps:  i  qualitative roll-back   ii  qualitative rollforward  and  iii  quantitative parameter estimation. 

1 	diagnosis 

　for hybrid systems  discontinuous changes in measured variables can only occur at the point of failure or at points at which discrete mode changes occur in the plant behavior. at all other time points the plant behavior is continuously differentiate. we take advantage of this fact for qualitative analyses of all measured variables  yk. the residual  rk  for any variable is defined as the difference between the measure plant output and the nominal expected plant output. since both of these are continuously differentiable after the fault occurrence  and after each mode change  the residual can be approximated by the taylor scries expansion: 
- * 
　we can then represent the residual as the coefficients of the magnitude and higher order derivative terms of the residual. instead of representing them in quantitative form  qualitative values  -  1  and +  are used to indicate if the coefficient is below  at  or above zero. 
　the qualitative analyses that comprise of the roll-back and roll-forward steps work on these qualitative coefficients. after detection of the fault  the signal to symbol generator is responsible for converting the measured observations to symbolic form at each time step. the discussion of the computation of the residual and the converting it to symbolic form is presented in   and not repeated here. 
the roll-back algorithm can be summarized as follows. 
given the observer estimated mode trajectory q = {q1.q1   we first use the back propagation algorithm  to generate hypotheses in mode the deviated symbols at the time of fault detection are back propagated through the temporal causal graph in mode qk to identify causes for the deviations. since the fault may have occurred in previous modes  we then go back in the mode trajectory and create hypotheses in each of the previous 
modes  where n is a number determined externally by diagnosability studies. during the crossover from a mode to a previous mode  the symbols need to be propagated back across the mode change. this is done by using the inverse of the reset functions  y1  associated with the mode transition. for example  the symbols to be propagated in mode qk.t is obtained as y 
 the hybrid hypotheses generation algorithm returns a hypotheses set    where each hypothesis h  is a three-tuple {q p k}  where q represents the mode in which the fault is hypothesized to have occurred  p is the parameter whose deviation corresponds to the fault  is the direction of deviation of parameter p. 
　the occurrence of the fault may change the parameters of the functions that determine autonomous transitions leading the observer to incorrectly predict  or not predict  an autonomous transition. hence the current mode estimated by the hybrid observer may not be the actual mode of system under hypothesized fault conditions. we need to estimate the current mode of the system for each hypothesis. however  we still do not have the quantitative value for the faulty parameter  implying that we cannot accurately determine the current mode of the system. to 

fig. 1: fault isolation and identification architecture 
solve this problem we take advantage of the fact that the same sequence of mode transitions in any order would lead the system to the same end state. this follows from the fact that each mode transition essentially changes the status of a switched junction in the hybrid bond graph representation. based on this observation  for each hypothesis  we apply all controlled transitions  assuming that no autonomous transitions have occurred  that have occurred since the hypothesized fault mode to get an estimated current mode. this is known as the roll-forward process. 
　we can now use the model  tcg  to predict the expected qualitative values for the residuals  signatures  in the current estimated mode for each hypothesis. this is done through a forward propagation algorithm . the fault hypotheses in the estimated current mode are com-
pared with the symbols generated by the signal to symbol generator using a progressive monitoring scheme . if there is a mismatch  the hypothesis cannot be dropped immediately  we assume that an autonomous mode transition may have caused this mismatch. we apply all possible autonomous transitions to the current estimated mode and derive m new estimated current modes for the hypothesis  where m is the number of possible autonomous transitions. for each of these m new modes  we can generate the qualitative signature using forward propagation and compare this against observations. in case of mismatch we hypothesize occurrence more autonomous transitions and repeat the process. once the total number of transitions  controlled + hypothesized autonomous  exceeds the diagnosability limit  further mismatches in signatures and symbols eliminate hypotheses. 
　in other work   we have shown the limited discriminatory capabilities of the qualitative progressive monitoring scheme. this often leads to multiple fault hypotheses being reported as the diagnostic result. even when we are left with only one hypothesis  determining the magnitude of the parameter associated with the hypothesis is essential to continue tracking the plant behavior in the faulty situation. we use a parameter estimation technique based on the least-squares estimation method for further fault isolation and identification. applying a statistical hypothesis testing scheme to the error in the fault identification task leads to unique fault isolation  

diagnosis 	1 

and an estimate of the deviated parameter value. consider the input output equation form: 

where u arc the inputs  y are the outputs  a's and b's are constant coefficients and q is the forward delay operator. the typical parameter estimation task is to estimate the a's and b's using measurements  u and y. the optimal estimate is given by: where 1 is a vector of a's and b's  is the regression vector  and z is current output vector. the single fault assumption implies that only one parameter in unknown. so  for each remaining hypothesis  we rewrite  in terms of the corresponding hypothesized fault parameter p. if we assume a first order polynomial relation  it is possible to extend this to arbitrary polynomial relations : 
where k1 and k   are matrix constants. now we can reformulate the estimation problem and obtain the optimal estimate for/1 as: 

　for each remaining hypothesis  we compute the input output equations of the system in the estimated current mode from the bond graph. this can be achieved by computing the temporal causal graph from the bond graph. the tcg can then be used to compute the signal flow graph  which can be used to derive the input output equations. please note that the signal flow graph still contains parameters in symbolic form as opposed to actual numeric values. this gives us a parameterized input output equation. we then calculate the k1 and k1 matrices. finally we accumulate u and y values  and estimate p using the above expression. this may also be used for fault isolation by plugging back the estimated parameter in the state space equations and computing the predicted values for the outputs. hypotheses whose predicted output values are statistically different from actual output values are eliminated. table 1 illustrates an experimental run for a left wing tank pump degradation  1% loss  at time step 1. the initial change was observed in the transfer manifold pressure at time step = 1  fig. 1   but two mode changes occurred between the fault occurrence and its detection. the roll back process was employed  and this produced an initial list of 1 candidates. detecting that the transfer manifold pressure was discontinuous reduced the candidate set to 1 faults. as other measurements deviated over time  first left wing tank pressure  then left feed tank pressure   the candidate set was further refined. mode changes required the re-derivation of the system models  and the computation of new signatures to track system behavior. the qualitative scheme reduced the candidate set to 1  and then the parameter estimation scheme was invoked. this resulted in generating the correct fault hypothesis  and a correct estimation of the faulty parameter. 
1 	experimental results 
we demonstrate the effectiveness of our diagnosis scheme on a real world example  the fuel system of fighter aircraft  fig. 1 . the pumps are modeled as a source of effort  pressure  with a transformation factor that defines its efficiency. the pipes are modeled as nonlinear resistances. 
　the diagnosis experiments used a controller sequence provided by boeing. the performance of the hybrid observer in tracking the nominal data  with 1% noise  through mode transfers is illustrated in figure 1 for the transfer manifold and left wing tank pressure measurements. the dots represent the measured data and the black line shows the observer estimates. a number of diagnosis experiments were run for different noise values and fault magnitudes  see  for details . 
table 1: fuel system diagnosability 

　table 1 summarizes the different fault classes that can be distinguished by our diagnosis algorithms. the fault classes are as follows:  i  wing tank pump  wtp    ii  wing tank resistance  wtr    iii  fuselage tank pump 
 ttp    iv  fuselage tank resistance  ttr    v  switched pipe resistance  spr    vi  feed tank pump  ftp   and  vii  feed tank resistance  ftr . the v mark in row i and column j indicates that fault class i can be distinguished from fault class j. the x mark indicates that the current controller sequence and set of measurements are not sufficient to distinguish between the pair in question. from the table  we see that we cannot distinguish between tank pump faults and tank outlet pipe resistance faults. however  this is true only for a pump efficiency  tf-  decrease and pipe resistance increase  r+ . since the pump efficiency cannot increase  no pipe resistance decreases  r-   i.e.  leaks  can be uniquely identified. all other classes of faults can be distinguished 

1 	diagnosis 


figure 1: transfer manifold and left wing tank 
pressure 
from one another. in sonic cases  the isolation may be achieved only after mode changes occur. 
1 	s u m m a r y 
   in this paper we have presented an integrated approach to solving the tracking  fault detection  isolation  and identification tasks for hybrid systems. the novel contribution of the presented work is the extension of continuous system model-based diagnosis techniques to hybrid systems. these include the hybrid observer that combines an extended kalman filter and hybrid automaton  hybrid fault isolation through roll back and roll forward using qualitative analysis  and the single parameter estimation for further fault isolation and identification. our work is motivated by the requirements of the fault accommodation task  where diagnosis has to be performed online for embedded systems during their operation. hybrid diagnosis techniques directly apply to embedded systems and else where . we have also demonstrated through time and space complexity analysis that our algorithms can be applied to online analysis in resource constrained environments. 
a c k n o w l e d g m e n t s 
the 	darpa/ixo 	sec 	program  f1-1   
nasa is ncc 1  and the boeing company  kirby keller and tim bowman  have supported the activities described in this paper. we would like to thank dr. gabor karsai  tivadar szemcthy  nagabhushan mahadevan  and eric manders for their help. 
