 
　the onyx program is designed to fill the need for planning in application areas where traditional planning methodology is difficult to apply. while the program being developed will assist with the planning of cancer therapy  its architecture is intended to be of use whenever goals are ill-specified  plan operators have uncertain effects  or tradeoffs and unresolvable conflicts occur between goals. we describe a planning process which uses strategic information and a mechanistic model of the domain. the process consists of three steps:  1  generate a small set of plausible plans based on current data   1  simulate those plans to predict their possible consequences  and  1  based on the results of those simulations  rank the plans according to how well each meets the goals for the situation. 
i introduction 
　traditional planning programs attempt to satisfy a goal with a sequence of actions  for example  strips  fikes  1  . each action is explicitly represented as an operator with preconditions and effects. the planner searches through a  state space  using operators to move between states. a successful plan is defined by a set of operators which generates a path of admissible states from the initial state to the goal state. the search through the state space is often aided by means-ends analysis. frequently subplans must be built to satisfy the preconditions of the operators in a higher level plan. 
　more advanced planners have dealt with the problem of interacting subgoals. noah  sacerdoti  1  uses a critic to repair incorrect or inconsistent plans. stefik's molgen  steflk  1  uses constraints and a least commitment approach to handle subgoal interactions. 
　however  in medicine and many other application areas  the planning task cannot be represented in a form useful to a conventional planner. often the goals are ill-specified and the operators have uncertain effects. furthermore  incomplete and unresolvable interactions occur between parts of the goal  limiting the usefulness of least commitment and plan repair techniques. consequently  medical therapy planning programs such as vm  fagan  
1   oncocin  shortliffe  1   and attending  miller  1  have frequently relied on algorithms or step-by-step protocols to provide explicit guidelines in the construction of plans appropriate to a particular patient's condition. 
　our work with oncocin in the cancer therapy domain has revealed an important limitation of medical planning systems which use explicit criteria such as algorithms and protocols. the knowledge in these specifications is a  compiled  version of pathophysiological knowledge of the human body and of the strategic knowledge of the domain. in oncocin  
　 support for this work was provided by the national library of medicine under grant lm/ca-1  the national science foundation under grant ist1  and ford aerospace under grant sp1cj. computing facilities were provided by the sumex-aim resource under nih grant rr-1 and by an equipment grant from the xerox corporation. plan elements are selected strictly according to the characteristics of the current treatment situation without considering the causal mechanisms of the domain or many of the strategies useful in prescribing therapy. consequently  when a situation arises for which the algorithmic knowledge does not apply  the planning system often recognizes the problem but cannot propose alternative therapy. the onyx system is designed to suggest expert quality therapy plans in such difficult cases. 
ii the onyx architecture 
　onyx is faithful to the standard planning paradigm when possible  but it has been extended to provide for the uncertain and ill-specified nature of the problem and to accommodate the time-dependent nature of the planning problem. 
　the planning process used by onyx consists of three steps: 
1. plan generation. using current and past data about the patient  and exploiting the hierarchical nature of possible plan steps  generate a small set of  plausible plans  which are consistent with the patient's current state. 
1. symbolic simulation. using knowledge about the structure and behavior of the human body  predict the future states of the patient after the execution of each plausible plan. 
1. plan ranking. using knowledge about how patient data satisfy goals for the patient's progress  rank each of the plausible plans according to the extent that the simulation's predictions for each plan meet the therapy goals. 
　the following three sections will describe each of these phases in more detail. 
a. plan generation 
　cancer treatment strategies are often general statements which may be applied to a wide range of decisions in the plan generation process  from broad therapeutic choices  e.g.  whether to give drug therapy or radiation therapy  to specific decisions about individual drug doses. one such strategy is:  if a problem is encountered with a treatment  try to eliminate the part of the treatment that might be causing the problem.  in one context  this is interpreted as a suggestion to decrease or eliminate the previously administered drug that is the likely cause of toxicity. in another context  it may be used to help decide between continued drug therapy and alternative treatments. currently  such a strategy must be represented in each context in which it applies  rather than as a single more general principle. 
　strategies are represented as two kinds of production rules. some strategies are control rules which guide the exploration of a therapy hierarchy  shown in figure 1. 
　
1 	c. langlotz et al. 
others are generation rules which propose plan steps associated with the leaf nodes of the therapy hierarchy. at present  we primarily use the general strategy  keep close to the standard plan  in guiding the exploration of the hierarchy. other strategies can be added as appropriate. 

　figure 1: the therapy hierarchy used in the plan generation phase of the therapy planning process. 
　the plan generation process begins at the root of the hierarchy. as each node is explored  the control rules associated with the node are examined to determine whether that node's descendants should be evaluated. for example  control rules associated with the drug treatment node determine if drug therapies could plausibly be given to the patient. we have previously used a similar process for plan analysis in an adaptation of the oncocin program  langlotz  1 . 
　when a leaf node in the hierarchy is reached  and the control rules suggest that the node corresponds to a reasonable class of therapies  generation rules are used to propose plausible plan steps. the conditions of generation rules test for patterns in past and present patient data. their actions propose plan steps based on interpretations of the data. an example generation rule is shown in figure 1. 
if *drug 1s a drug in *chemotherapy  
 x 1$ one of the current problems 
 drug 1s not one of the causes of *x  but 
　　*drug can contribute to *x then reduce the dosage of *drug 
　figure 1: a generation rule in onyx. variable names are preceded by asterisks. 
complete therapy plans are subsequently formed by taking consistent collections from the proposed plan actions. the consistency is enforced by checking that the conditions of the rules which proposed each plan action are not contradicted by other actions in a collection. 
b. symbolic simulation 
　simulations are useful in predicting the consequences of carrying out proposed plans. but since knowledge of causal mechanisms in the medical domain is both uncertain and incomplete  it is difficult to find invariant quantitative mathematical relationships between parameters in our models. consequently  deterministic mathematical models like those used in ai/mm  kunz  1  are not acceptable. 
　the work of kuipers  kuipers  1  suggests useful alternatives to a completely quantitative approach. qualitative simulations provide a way of expressing qualitative values for the states and trends of a set of interrelated variables in a system. heuristics are used to help envision possible future states for the system. but these techniques cannot resolve the conflicting trends which occur so frequently in oncology. furthermore  they do not represent the uncertainty in the processes they attempt to describe. 
　the need to address the problems of conflicting trends and uncertain relationships prompted us to develop a simulation architecture for onyx in which both the structure and behavior of the model are represented symbolically. simulation models are organized hierarchically according to part-of relationships. the behavior of each model is determined by the behavior and interconnections of its parts and by three knowledge bases  described below  which specify the model's behavior in response to stimuli. the state of each model is represented by a group of stafe variables  and by the state of its parts. each model has ports through which it communicates with other models using simple message passing. 
hierarchical models are built interactively on a xerox 1 
lisp workstation. a representation of three such models as they appear on the 1 screen is shown in figure 1. the box on the left shows the body model. one of the parts of the body model  the bone marrow model  is shown at the center. the marrow space model  which is a part of the bone marrow model  is shown at the right. the boxes containing x's are the ports through which the models communicate with one another. 
　the behavior of each model is described by three rule bases containing production rules. the first rule base 
　

　figure 1: each of the three large rectangular boxea signifies a model solid lines represent connections between models. 
　
dictates how a model will respond to the stimuli it receives from other models through its ports. the second rule base contains knowledge about how to make further conclusions about the model's state based on any recent changes. the third rule base dictates how the new state of the model will be transmitted to neighboring models using a simple message passing scheme which acts along connections between models. 
　at present  a simulation of the models shown in figure 1 can predict the behavior of the bone marrow in response to the intravenous administration of a hypothetical anti-cancer drug. this initial stimulus is propagated throughout the models using rules in each about the flow of the blood throughout the body. in the bone marrow  the drug moves from the blood space to the marrow space  where it is transmitted from the extracellular fluid to each cell population. rules in the model of each cell population are used to predict the drug's effect on the size  growth  and maturation rates of these cells. these rates are currently represented by simple numeric constants  which are modified in response to the drug. as the simulation proceeds  visual representations of the simulation events are shown on the 1 display. for example  a graphical image of the drug is shown moving along the connections of the model to represent its movement in the body. 
　when the simulation is complete  the history of state variables can be plotted against time. the response curve shown in figure 1 shows the simulation's prediction of the amount of cells in a particular marrow population  as plotted on the screen. because these cells are key indicators of toxicity caused by drug therapy  information of this kind can ultimately be used to help estimate the extent to which a plan has met the treatment goals. 

　figure 1: a plot generated by the simulation which shows the size of a population of bone marrow cells over 1 days. 
c. plan ranking 
　while the plan ranking phase of onyx remains substantially unimplemented  we are experimenting with decision analytic techniques which rank alternative plans. these techniques require knowledge of the alternatives  probabilities  and preferences inherent in the decision situation  howard  1 . the current onyx architecture can be readily augmented to provide this information. 
　treatment alternatives are already provided by the plan generation mechanism. we intend to augment the symbolic simulation so that it can provide the probabilities of possible outcomes  rather than simple deterministic predictions. preferences for the patient will be explicitly represented as at least three general goals:  1  to improve the patient's prognosis   1  to reduce the treatment risk for the patient   1  to remain close to the protocol guidelines for treatment when possible. knowledge about how significant patient outcomes affect each of these goals  together with the relative importance of these goals  will allow computation of the relative utility of alternative plans. 
ill conclusion 
　traditional techniques cannot solve planning problems in many application areas. onyx's three-step planning 
	c. langlotz et al. 	1 
process has been developed as an alternative. the first step in the planning process constrains the generation of possible plans. the second step attempts to predict how each plan might affect the patient. the third step will rank how well the possible future consequences of plans satisfy the goals for the patient. these three components of the onyx system are not yet sufficiently complete to cooperate in generating a ranked set of plans. our next task is to combine them to form a coherent planning system. we then intend to integrate the strategic and mechanistic knowledge in onyx with the protocol-based knowledge in oncocin  thereby augmenting its decision-making and explanatory capabilities. 
acknowledgements 
　special thanks are due to mark stefik  danny bobrow  and sanjay mittal for their help with the initial design of onyx and with the loops programming environment. mark musen  glenn rennels  ted shortliffe  and cliff wulfman provided helpful comments on earlier drafts of this paper. we are also grateful for the collaboration of project members michael kahn and peter tarczy-hornoch  and for the helpful support of the members of the oncocin project. 
