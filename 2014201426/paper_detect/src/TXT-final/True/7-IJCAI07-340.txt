
the ability to build maps of indoor environments is extremely important for autonomous mobile robots. in this paper we introduce voronoi random fields  vrfs   a novel technique for mapping the topological structure of indoor environments. our maps describe environments in terms of their spatial layout along with information about the different places and their connectivity. to build these maps  we extract a voronoi graph from an occupancy grid map generated with a laser range-finder  and then represent each point on the voronoi graph as a node of a conditional random field  which is a discriminatively trained graphical model. the resulting vrf estimates the label of each node  integrating features from both the map and the voronoi topology. the labels provide a segmentation of an environment  with the different segments corresponding to rooms  hallways  or doorways. experiments using different maps show that our technique is able to label unknown environmentsbased on parameters learned from other environments.
1 introduction
building semantically meaningful representations of indoor environments is a fundamental goal of robot mapping. over the last few years  the slam  simultaneous localization and mapping  community has made tremendous progress in the development of efficient and highly accurate map-building techniques. most of these techniquesfocus on accuratelycapturing the metric layout and/or topological structure of an environment. while raw metric maps have the advantage of being well suited for robot navigation tasks  they are typically unstructured and contain no information about the different types of places or objects in an environment. topological approaches are more compact and expressive in that they describe locally distinctive places  but these distinctive places are often defined in a robot's perceptual space and are not necessarily related to indoor areas such as rooms or hallways.
　other researchers  for instance  beeson et al.  1   focused on detecting places such as rooms  hallways  and doorways. however  most of these techniques detect only very specific structures and rely on hand-tuned rules to do so. recently   mozos et al.  1  introduced a technique that uses adaboost to learn place classifiers based on various features extracted from laser range-scans and cameras. while they achieve good results in classifying individual points in an environment  their approach does not take the connectivity of these points into account  and so does not generate a topological  spatially consistent representation of an environment.
　the goal of our research is to generate semantically meaningful  topological-metric descriptions of indoor environments. we aim to label every location in a metric map of an environment with the type of place it belongs to. these labels provide an intrinsic segmentation of the map  one that represents the topological structure of an environment. such a structure will enable robots to better communicate with humans about places  goals  and trajectories.
　to achieve this goal  we introduce voronoi random fields  vrfs   a novel method for generating semantically meaningful descriptions of indoor environments. our approach uses a state-of-the-art slam technique to generate a metric occupancy grid map of an environment  fox et al.  1 . it then extracts the voronoi graph of this map  latombe  1   which provides a compact representation of the free space and the connectivity structure of the environment. for each point on the voronoi graph  vrfs then estimate the type of place it belongs to. this is done by generating a conditional random field with hidden nodes corresponding to the points on the voronoi graph. conditional random fields are discriminatively trained graphical models that have been shown to outperform generative approaches in areas such as natural language processing  lafferty et al.  1  and computer vision  kumar and hebert  1 . the place labels estimated by our voronoi random field provide a segmentation of an environment  with the different segments corresponding to rooms  hallways  junctions  or doorways. since a robot's place labels should be consistent with how humans perceive the structure of environments  we use human-labeled training data to learn the parameters of our vrfs.
　the paper is organized as follows. after describing related work in section 1  we introduce voronoi random fields  our application of conditional random fields to labeling voronoi graphs  and also show how to perform inference and learning in this model. experiments are described in section 1  followed by conclusions and a discussion of future work.
1 related work
voronoi graphs are an extremely useful topological representation of indoor environments  latombe  1 .  thrun  1  constructs topological representations of environments by segmenting and pruning a voronoi graph extracted from an occupancy grid map. this approach does not distinguish between different types of places and is rather brittle since it makes deterministic modeling decisions based on manually tuned  local features. in order to learn a topological map of an environment   kuipers and beeson  1  generate distinctive views by unsupervised clustering of raw laser range-data and associate these views with distinctive states.  tomatis et al.  1  represent places in a hybrid topological-metricmap as corners and openings detected with a laser range-finder. their focus is on place recognition for slam  and the topological nodes are not classified into types of places.
　 beeson et al.  1  detect topological places based on gateways and pathways in a reduced extended voronoi graph  which they extract from occupancy grid maps. their technique relies on various hand-tuned rules to detect places and the authors do not show how it generalizes to complex scenarios in unseen environments.
　our work focuses on place classification. we do not intend to detect individual  distinctive places  but rather aim at labeling any location in an environment. furthermore  we do not try to solve the place recognition  or data association  problem  which aims at detecting when a robot has returned to a previously visited place  tomatis et al.  1 . we build on the fact that this problem is solved sufficiently well by stateof-the-art slam techniques  which generate accurate laser range-maps of indoor environments  fox et al.  1 .
　in a similar vein as our research   stachniss et al.  1  use adaboost to learn place classifiers based on features extracted from laser range-scans and camera images. they show how to connectthe classifier outputsto a hiddenmarkov model  which then performs hmm filtering on the trajectory followed by a robot. while this technique performs very well  it still has several limitations compared to our approach. the hmm only operates on the given trajectory  so the classification of places in an environment depends on the actual path followed by a robot. furthermore  the approach is not able to make use of the connectivity of an environment when labeling places. in contrast to hmm filtering  we show how to perform collective labeling on a voronoi graph of an environment. our model thus takes both local features and connectivity informationinto account. additionally  it is able to generate a topological  semantically labeled graph description of an environment.
1 voronoi random fields
1 conditional random fields
conditional random fields  crfs  are undirected graphical models that were developed for labeling sequence data  lafferty et al.  1 . unlike hmms and markov random fields  which assume that observations are independent given the hidden state  crfs make no assumptions about the dependency structure between different parts of the data. crfs are thus especially suitable for classification tasks that rely on complex and overlapping data and features.
the nodes in a crf represent hidden states  denoted y =
  and data  denoted x. note that while individual observations xi are often connected to the corresponding hidden states yi  our data x consists of a complete map of an environment  and we connect all hidden states to this single map. the nodes yi  along with the connectivity structure represented by the undirected edges between them  define the conditional distribution p y|x  over the hidden states y. let c be the set of cliques in the graph of a crf. then  a crf factorizes the conditionaldistributioninto a productof clique potentials φc x yc   where every c （ c is a clique in the graph and x and yc are the observed data and the hidden nodes in the clique c  respectively. clique potentials are functions that map variable configurations to non-negative numbers. intuitively  a potential captures the  compatibility  among the variables in the clique: the larger the potential value  the more likely the configuration. using clique potentials  the conditional distribution over the hidden states is written as
	 	 1 
 where is the normalizing partition function. the computation of this partition function is exponential in the size of y since it requires summation over all possible configurations of hidden states y. hence  exact inference is possible for a limited class of crf models only.
　potentials φc x yc  are described by log-linear combinations of feature functions fc    i.e. 
	 	 1 
where wct is the transpose of a weight vector wc  and fc x yc  is a function that extracts a vector of features from the variable values. using feature functions  we rewrite the conditional distribution  1  as
		 1 
 before we describe how to perform efficient inference and learning in crfs  we will show how crfs can be used for labeling places in an environment.
1 voronoi random fields for place labeling
to label the different places in an environment  we estimate the place types at the points of a discrete voronoi graph of the environment. such a graph is defined via the points that are equidistant to the closest two or more obstacles in an environment  latombe  1 . the left panel in figure 1 shows an occupancy grid map generated by our laser mapping approach along with the corresponding voronoi graph  after pruning . as can be seen  the voronoi graph nicely represents the connectivity structure of the environment. hallway intersections and their entries into rooms are typically represented by points that have three or more neighbors. note that any point in the environment can be associated with a point on the voronoi graph. thus  by estimating place labels on the voronoi graph  we can determine the place type of any point in the environment.
　we label the points on a voronoi graph by converting the graph into a conditional random field  which we call a voronoi random field  vrf . a vrf is constructed from a voronoi graph by representing the points vi on the voronoi graph as the hidden nodes yi of the vrf. the state of the hidden nodes ranges over the different place types: room  doorway  hallway  junction  and other. the neighboring points in the voronoi graph are also connected in the vrf  thereby allowing the vrf to take the labels of neighboring points into account and thus probabilistically model connectivity constraints. the observed data x is extracted from the voronoi graph and the local map area visible from each voronoi point. we use two types of features extracted from the data:
spatial features describe the layout of the local area around a voronoi point. most of of our spatial features are inspired by those used by  stachniss et al.  1  for laser-based place detection. these features are extracted from the occupancy grid map; they include distance to the closest obstacle and shape information about the area visible from the voronoi point.
connectivity features make use of the connectivity information encoded by the voronoi graph. these features include place types of the neighboring nodes  number of neighbors in the voronoi graph  and shape information about the graph  such as curvature. additionally  we use a feature that describes the size of the minimal loop going through a node in the voronoi graph. this feature is extremely useful for tasks such as distinguishing doorways from narrow passages in rooms. while doorways are typically not part of a small loop  small loops with narrow passages are often caused by furniture such as tables  see figure 1 .
our vrfs contain three types of cliques. first  each node in the vrf is a single node clique  the potential of which is a weighted function of the spatial and connectivity features extracted at that node. the second type of clique contains pairs of vrf nodes that are connected in the voronoi graph. the potential of these cliques measures the spatial compatibility between place types. a third type of clique is generated for each node that has three neighbors. while such  junction  nodes often correspond to intersections in hallways  they also occur frequently in rooms. this final clique type contains four nodes and measures the compatibility between the labels of all nodes connected at such a junction in the voronoi graph  more than three neighbors could be handled if necessary .
1 inference
inference in crfs can estimate either the marginal distribution of each hidden variable yi or the most likely configuration of all hidden variables y  i.e.  map estimation   as defined in  1 . both tasks can be solvedusing belief propagation  bp   which works by sending local messages through the graph structure of the model. each node sends messages to its neighbors based on messages it receives and the clique potentials  which are defined via the observations and the neighborhood relation in the crf. for instance  the  observation  potential of a node is computed by first extracting the features described in section 1 at the map location corresponding to the node  and then feeding them through the log-linear function  1   we actually use derived features  see section 1 .
　bp generates provably correct results in graphs with no loops  such as trees or polytrees. however  since virtually all vrfs contain loops  we apply loopy belief propagation  an approximate inference algorithm that is not guaranteed to converge to the correct probability distribution  murphy et al.  1 . in our experiments  we compute the map labeling of an environment using max-product loopy bp. fortunately  even when the algorithm failed to converge  our experiments showed reasonable results.
1 learning
crf parameter learning
the goal of crf parameter learning is to determine the weights of the feature functions used in the conditional likelihood  1 . crfs learn these weights discriminatively by maximizing the conditional likelihood of labeled training data. while there is no closed-form solution for optimizing  1   it can be shown that  1  is convex relative to the weights w. thus  the global optimum of  1  can be found using a numerical gradient algorithm. unfortunately  this optimization runs an inference procedure at each iteration  which can be intractably inefficient when using loopy bp in large vrfs.
　we therefore resort to maximizing the pseudo-likelihood of the training data  which is given by the sum of local likelihoods p yi | mb yi    where mb yi  is the markov blanket of variable yi: the set of the immediate neighbors of yi in the crf graph  besag  1 . optimization of this pseudolikelihood is done by minimizing the negative of its log  resulting in the following objective function:

 here  the terms in the summation correspond to the negative pseudo log-likelihood and the right term represents a gaussian shrinkage prior with mean w and variance σ1. without additionalinformation the priormean is typically set to zero. in our approach  we use unconstrained l-bfgs  liu and nocedal  1   an efficient gradient descent method  to optimize  1 . the key advantage of maximizing pseudolikelihood rather than the likelihood  1  is that the gradient of  1  can be computed extremely efficiently  without running an inference algorithm. learning by maximizing pseudolikelihood has been shown to perform very well in different domains; see  richardson and domingos  1  or  kumar and hebert  1  for an example.
adaboost for feature induction
while the features described in section 1 could be used directly as continuous observations in crfs  we found that this approach did not yield very good results. this is due to the fact that the log-linear representation underlying crfs corresponds to a unimodal gaussian likelihood for each continuous feature  which is not flexible enough to capture the complex relationships between place types and feature values.
　we overcome this limitation by extracting suitable features from our continuous feature values using adaboost  freund and schapire  1   which has been applied successfully by  mozos et al.  1  in the context of place recognition. specifically  we learn a binary adaboost classifier for each place type by using maps of labeled indoor environments to generate training data for every class c in the form of
  where each xi con-
tains the features extracted for a specific voronoi point  and yi （ { 1 +1} specifies whether or not this point belongs to the class c. as weak classifiers we use binary decision stumps applied to the features. in this case  adaboost sequentially learns a weighted set of t decision stumps  each defined by a feature ftc and a threshold θtc. note that the same feature can be used multiple times with different thresholds. the weighted combination of these decision stumps gives the classification of whether or not a feature vector x belongs to place type
 1 
here hct x  = sign xftc   θtc  is the output of the t-th decision stump  and αct is the learned weight associated with it. essentially  adaboost automatically determines which of the continuous features  and thresholds applied to them  are most useful in supporting good classification results.
　we investigated two ways of combining adaboost and crfs. the first  which we call v rfd  takes all the adaboost decision stumps hct x  learned for all the classes c and uses them as binary features in a crf. the crf then learns the weights for those stumps and for the neighborhood potentials using pseudo-likelihood maximization as described above. the second approach  called v rfm  uses the weighted sum  or margin  niculescu-mizil and caruana  1   of each adaboost classifier as a continuous feature  the sum inside the sign in  1  . for c place types  v rfduses ct binary features  t for each of the c place types  and v rfmuses the c continuous features that are generated by weighted summation of the decision stumps.
1 summary
our approach learns the parameters of vrfs from labeled maps of training environments. to do so  it first learns a binary adaboost classifier for each place type from manually labeled maps. for each map  we generate the corresponding voronoi randomfield using the features learned by adaboost. the parameters of these vrfs are then learned by maximizing the pseudo-likelihood  1  of the training data  using parameter sharing. the resulting parameters are the weights of the different types of cliques occurring in a vrf. after learning  a novel environment is labeled as follows:
1. generate occupancy grid map using mobile robot laserrange slam techniques  fox et al.  1 .
1. extract voronoi graph from the map.
1. generate voronoi random field with nodes and edges corresponding to the voronoi graph.
1. extract spatial and connectivity features from the map and generate the learned adaboost decision stumps to be used as observations in the vrf.
1. run max-product loopy bp inference to estimate the map labeling of the nodes in the vrf.
1 experimental results
we evaluated our approach on maps of four indoor environments  acquired as laser range-data from the radish robot data repository  howard and roy  1 . for each data set  we generated an occupancy grid map and extracted a voronoi graph from that map. we then manually labeled each point on each graph as either room  doorway  hallway  or junction  where a junction can be an intersection between hallways or an entry area into a room. the training set contained approximately 1 voronoi points. we extracted 1 different features at each point and used adaboost to generate 1 decision stumps for each of the four classes  resulting in a total of 1 binary features used in our vrfs. adaboost learning took about a minute; learning the parameters of a vrf took an additional minute on a standard desktop pc. loopy-bp map inference generally took less than a minute per test map when it converged. however  we allowed for a generous time-out based on the graph diameter  such that those that did not converge would run for up to 1 minutes.
　to assess the contributions of the different aspects of our vrf framework  we compared the following four approaches using leave one out cross-validation on the maps. the first  denoted abs  uses adaboost along with the spatial features to classify each point on the voronoi graphs. the second  absc  additionally uses connectivity features extracted from the voronoi graphs. these features include information such as number of neighbors in the graph  size of the smallest loop containing a node  and the distance to the closest obstacle. the third approach  v rfd  is a vrf that uses the adaboost decision stumps as binary features. the final approach  v rfm  uses the weighted sum  or margin  of each adaboost classifier as features. for learning  we set the prior mean of all weights w  to zero  compare  1  .
abld.allenfrbg.intelavg.abs11111 ＼ 1absc11111 ＼ 1v rfd11111 ＼ 1v rfm11111 ＼ 1table 1: accuracy of leave one out place labeling.
　table 1 summarizes the accuracy of the different techniques in terms of the percentages of correct labels for the four test environments. not surprisingly  the accuracy of adaboost increases consistently when adding connectivity features  for an average increase from 1% to 1% . the lower two rows display the accuracy of using adaboost for feature induction in vrfs. both vrf approaches perform significantly better than adaboost  though the difference between them is not significant. note that the test maps are very diverse  so the cross-validation demonstrates good generalization to new environments for all techniques.

figure 1: intel test map:  left  occupancy grid map built via slam along with voronoi graph.  middle  the labeled voronoi graph defines a place type for each point on the map. hallways are colored gray  red   rooms light gray  green   doorways dark grey  blue   and junctions are indicated by black circles.  right  topological-metric map given by the segmentation of the labeled voronoi graph. the spatial layout of rooms and hallway sections is provided along with a connectivity structure indicated by lines and dots  doorways are dark gray  blue  dots .　while these numbers indicate an improvement of vrfs over adaboost  they do not adequately reflect the true performance gain achieved by our vrf technique. to get an additional assessment of the techniques  we considered the following scenario. a mobile robot is placed at a random location in the map and takes the shortest path to another randomly chosen location. along its path  the robot records the sequence of rooms  hallway sections  junctions  and doorways it passes through. we used edit distance to compare sequences recorded on maps labeled using our algorithms to those recorded on ground truth maps. edit distance determines the minimum number of operations  insertions  deletions  needed to make the inferred path match the ground truth path. our resulting measure  called topological edit distance  ted   reports the ratio of edit distance to path length; a lower ted ratio means better performance. the final reported statistic is the average of 1 randomly selected paths in the map. the random paths taken on the corresponding maps in different tests were chosen consistently to allow a straightforward comparison. the ted scores of the aforementioned experiments are summarized in table 1. the v rfdmethod offers clear improvements significant at the p 1 level over absc. the v rfmmethod appears better  but the overall improvement is insignificant due to poor performance on the allen map. one explanation for this is that v rfmfailed to correctly label several junctions between hallways  which many paths will pass through.
abld.allenfrbg.intelavg.abs11111 ＼ 1absc11111 ＼ 1v rfd11111 ＼ 1v rfm11111 ＼ 1table 1: topological edit distance of leave-one-out place labeling.
　figure 1 shows the performance of our technique on one of our test maps  shown for v rfd  v rfmis very similar . the coloring of the middle map is given by labeling all points with the label of the nearest point in the vrf. the right panel shows the exploded topological-metric map resulting from grouping contiguous room and hallway regions of the same label into topological nodes. as can be seen  the topologicalmetric map generated automatically by our vrf nicely represents the environment'sconnectivity structure  indicated by lines and doorway and hallway nodes  and the spatial layout of individual rooms and hallway sections. figure 1 provides a visual comparison of v rfdwith absc adaboost using spatial and connectivity features . in agreement with the results given in table 1  our approach generates significantly more consistent segmentations of the environments. for instance  adaboost generates a large number of false-positive doorways and hallways  especially in the cluttered rooms of the freiburg map. our labelings are also more consistent than those reported by  stachniss et al.  1 .
1 conclusions
we presented voronoi random fields  a novel approach to generating semantically meaningful topological-metric descriptions of indoor environments. vrfs apply discriminatively trained conditional random fields to label the points of voronoi graphs extracted from occupancy grid maps. the hidden states of our vrfs range over different types of places  such as rooms  hallways  doorways  and junctions. by performing inference in the graph structure  our model is able to take the connectivity of environments into account. we use adaboost to learn useful binary features from the continuous features extracted from voronoi graphs and occupancy maps. the parameters of our model are trained efficiently using pseudo-likelihood. experiments show that our technique enables robots to label unseen environments based on parameters learned in other environments  and that the spatial reasoning supported by vrfs results in substantial improvements over a local adaboost technique.
　we consider these results extremely encouraging; they provide mobile robots with the ability to reason about their environments in terms more similar to human perception. as a next step  we will add high-level contextual information such as the length of hallways and the shape of rooms to our model. each segmentation will then correspond to a two-level crf  with the upper level representing the features of these places  similarly to  liao et al.  1  . to avoid summing over all possible crf structures  we will replace map estimation with a sampling or k-best technique.
an obvious shortcoming of our current approach is the re-

figure 1: abuilding  left  and freiburg  right  test maps labeled by adaboost  upper row  and our vrf technique  lower row . the vrf technique is far more accurate in detecting junctions and its segmentations are spatially more consistent than those done by adaboost.striction to laser range data. as in the work of  stachniss et al.  1; torralba et al.  1   we intend to add visual features in order to improve place recognition.
　finally  the longterm goal of this research is to generate maps that represent environments symbolically in terms of places and objects. to achieve this goal  we will combine our vrf technique with approaches to object detection  such as the one proposed by  limketkai et al.  1 . in this application  the place labeling performed by the vrf will provide context information for the object labeling performed jointly at the lower levels of a hierarchical crf model.
acknowledgments
this work has partly been supported by nsf career grant number iis-1  and by darpa's assist and calo programs  contract numbers: nbch-c-1  sri subcontract 1 .
