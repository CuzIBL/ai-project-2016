 
many of today's electro-mechanical devices exhibit both continuous and discrete behavior  modeling these hybrid systems presents special challenges for automated modeling and simulation. we show how nonstandard analysis overcomes these challenges  provides a firm mathematical foundation  and satisfies our intuitions about the behavior of hybrid systems. 
1 introduction 
many of today's electro-mechanical devices exhibit both continuous and discrete behavior. modeling these hybrid systems presents special challenges for automated modeling and simulation. work in discrete event simulation  cassandras  1  assumes that all change is discrete; work in quantitative and qualitative simulation assumes that all change is  at least piecewise  continuous. the behavior of hybrid systems  such as digitally controlled copiers  chemical plants  automobiles  and so on  is not appropriately characterized as either continuous or discrete. 
　a hybrid model of a system is often the result of an abstraction that simplifies analysis and the prediction of behavior. for example  we often view closing a switch as causing the voltage difference across the switch to become 1 in an instant; a level sensor in a reactor vessel causes a pump to shut off and a valve to close in an instant. in principle  it is possible to construct continuous models of these behaviors  but they are considerably more complicated. in practice  the use of discontinuous abstractions is both ubiquitous and necessary. for instance  the transient behavior of control electronics is often irrelevant to the task of analyzing the overall system. complex sequences of discrete actions are also possible  such as when an automobile ignition is turned on  relative to the vehicle's motion  or a camera's shutter is depressed. 
a satisfactory model for hybrid systems must support: 
  discrete actions occurring in the presence of contin-uous change; 
vijay saraswat  daniel bobrow  
vineet gupta 
palo alto research center 
xerox corporation 1 coyote road palo alto  ca  1 
  complex sequences of discrete actions; 
  the abstraction that discrete actions are instanta-neous. 
we can refine the third criterion: it must not be possible to measure the duration of a discrete action with a continuous real-valued clock-
　there have been several attempts to introduce discrete changes into a continuous model  forbus  1; nishida and doshita  1; iwasaki and low  1 . problems with the mathematical semantics arise  however  because discrete changes violate the assumption of continuity. giving sound semantics to the representation of discrete changes while employing the real number line as the model of time  as is usually employed in modeling of continuous systems  and respecting the underlying semantics of continuous change turns out to be very difficult. 
　we provide a sound mathematical basis for modeling hybrid systems that satisfies the three desiderata listed above. the hybrid systems are specified by discrete actions as well as qualitative or quantitative continuous functions. our solution is based on nonstandard analysis  hoskins  1 . we employ a nonstandard model of time  which captures the intuitive distinction we would like to make between discrete and continuous changes. more importantly  it allows us to model both continuous and discrete changes uniformly without contradictions or introducing unnecessary complexity. 
1 discrete actions in continuous systems 
consider the simple circuit shown in figure 1  in which electric power is provided to a load either by a solar array or a rechargeable battery. the charge on the battery is maintained by a solar array. when the charge level of the battery exceeds a threshold  the charge-current controller opens the relay  allowing the battery to provide power to the load. when the charge level drops below another threshold  the charge-current controller closes the relay  allowing the solar array to recharge the battery. it is natural to model this system by a mixture of continuous and discrete behavior. 
	iwasaki  etal 	1 
　

　the following axioms define the continuous behavior of the system. a continuous change is specified by a form c : c =  e  where c is the name of the continuous change  c is the condition for the change to take place  and e is its consequences. the antecedents  c  and the consequences  e  hold simultaneously. we will use the notation c t  to denote that c holds at time t. 
　since each one of dl - d1 represents an actual action of a physical component  it does take some nonzero amount of time for the consequences to take effect after the condition becomes true. however  the discrete actions are extremely fast relative to the continuous changes  and their dynamics are uninteresting for the purposes of modeling the overall circuit. thus  we would like to model them as being instantaneous. in other words  we would like the model to capture the notion of almost instantaneous change taking place without any measurable duration. 
　while intuitively plausible  this interpretation of instantaneous changes raises a fundamental problem in modeling of continuous systems. typically  time is taken to be isomorphic to the real number line. thus  any temporal behavior can be viewed as a sequence of states that hold alternately at an instant and over an open interval  this representation is also used in qualitative reasoning . it works very well when there are no discrete changes. the qualitative behavior of the system  without the discrete behaviors specified by dl through d1  is shown in figure 1 a . in the portion of the behavior shown in figure 1  qba is steadily increasing  until it reaches the threshold q1 at time t = t1. states so and s1 are instantaneous states at time points to and t1; s1 and s1 are states corresponding to the open intervals  t1 t1  and 
 t1 	 . 
　
d 1 : -'high signal  a ~ closed  relay  -  closed relay  when the signal from the controller goes low  the relay closes. 
d 1 : qba   q1  ~high signal  -  high signal  
when the controller detects the charge level in the battery has reached q1  it turns on the signal to the relay. 
figure 1: behavior of the circuit in figure 1. 
　add to this behavior the actions of the controller and the relay represented by the actions d1-d1. the antecedent of d1 becomes true in the instantaneous state s1. thus  at the time t1  immediately followingt1  the signal goes high. at yet another time  t1  immediately 
following t1  the relay opens due to action d l . our intuitive notion about these instantaneous changes is that 
　
1 	qualitative reasoning and diagnosis 
　
　option 1 has the additional disadvantage of arbitrarily assigning an instant or an open interval to the duration of an action depending on where it happens to appear 
　
　if we use the real number line as the model of time  it is impossible to produce a description that matches  exactly our intended interpretation of the discrete actions. on the real number line  there is no well-defined notion of a point immediately following a point. even though we would like to say that there is a time point at which signal goes high and which  immediately follows  t1. we cannot because the point t1 must be followed by an open interval of non-zero length. this forces us to take one of the following approaches: 
1. since actions are supposed to take little time  as-sume that they take no time. in other words  rules such as d1 through d1 are treated just like ordinary logical implications with respect to time. 
1. always insert a small  open interval of unspeci-fied length between the time points at which consequences of actions become true. this corresponds to the state sequence in figure 1 c . states s1.1i and  last over small open intervals. 
1. make the consequences of an action true in either the point or the interval that immediately follows the current state. this corresponds to the state sequence in figure 1 d . states and are instantaneous while s1 lasts over a small open interval. 
　each of these approaches has difficulties. approach 1 is obviously flawed - if actions are logical implications  then any of d1-d1 directly produces a contradiction. in general  there are many control actions that take place only if the desired effect is not already in place. the antecedent for such actions will include the negation of the consequence; this immediately leads to a contradiction when actions are treated as implications. 
　with both approaches 1 and 1  the value of  continuous  variables become unknown after a sequence of actions. there are two possibilities for the value of qba at time  as shown in figure 1 a . since the sun remains up and the relay remains closed until state s1 qba continues to increase past  until s1 since there is a non-zero amount of time that passes between s1 and s1 
　 must have some value above q1  say q1  where 1 is in a sequence. if the first action in a sequence occurs at a time instant  then all odd-numbered actions will occur at an instant. if it had occurred over an interval  then all odd-numbered actions would occur at intervals. this is an undesirable and bizarre artifact of the particular model of time employed and has nothing to do with what the actions represent. 
　this example has demonstrated problems that arise when we try to represent hybrid systems while using the real number line as the model of time. in summary  the problems are 
1. we cannot have a sequence of instantaneous states one immediately following the other. 
1. we cannot ignore the change  if any  in the value of continuous variables over the time in which discrete actions take place. 

	iwasaki etal 	1 

　in summary  a system * r of hyperreal numbers is r extended with infinite numbers of infinitesimal and infinite elements  and it is closed under addition and multiplication. a significant aspect of *r for our present purpose is that it gives us the notion of infinitesimal differences between two points of time  or quantity values  that are smaller than the difference between any two standard real numbers. furthermore  infinitesimal differences never add up to a standard number as long as there are only a finite number of them. 
　in order to make * r our model of time  and the range of continuous functions   we must have a definition of continuity in * r. in standard analysis  continuity of a function / at a is defined as 

1 	a nonstandard model of hybrid systems 
we now describe our model of hybrid systems based on calculus of hyperreals and show how our approach overcomes the difficulties discussed in section 1. 
　we use the hyperreals as the model of time as well as of the domain of continuous functions. we assume that the functions used to describe the continuous part of the behavior are q-continuous in * r. discrete actions are understood as follows: d : c -  e means that whenever c holds at to  there is a t1   to such that to 「t1 and e t1 . a more precise semantics is given in section 1. 
　this definition of an action allows us to have a sequence of instantaneous states one after another  each of which is distinct but infinitely close to its predecessor. furthermore  the value of a continuously changing variable changes only by an infinitesimal magnitude over any 
finite sequence of such instantaneous states. therefore  if we want to compute the standard part of a continuously changing variable's value  we can always ignore the nonstandard part when the number of discrete changes is finite. the nonstandard part can never become large enough to make a difference in the standard part. 
　note that for d : c -  e  we do not require that e entail -ic  as is the case in all the examples of discrete actions in section 1 . however  it is in general a good idea to represent actions in such a way that the consequence invalidates the condition because  otherwise the action will end up being repeated an infinite number of times. 
　the example in figure 1 yields a state sequence as depicted in figure 1  where the time axis is now the hyperreal number line. the states s1  s1 and s1 are distinct states  but the gaps between them are infinitesimal. thus  we can safely say that the standard part of the value of qba in state si 1 is equal to that in state s1 without contradicting the continuity assumption or the equation in c1. 

　
1 	qualitative reasoning and diagnosis 
　
figure 1: behavior of the circuit in figure 1 with a nonstandard model of time. 
　notice that this semantics of continuous and discrete behavior based on nonstandard model of time allows us to capture in the most natural way what we mean intuitively by discrete actions without violating the basic continuity assumptions. it also allows us to avoid introducing 1's of an unknown magnitude into the value of continuously changing variables  unnecessarily com-
　
plicating computation. 
1 	t e m p o r a l projection 
the task of modeling hybrid systems requires both a mathematical foundation that allows the behavior of a 
hybrid systems to be described and algorithms that predict the behavior from such a description. in this section  we discuss the problem of prediction  particularly with regard to predicting behavior across discrete changes. 
　predicting behavior requires us to solve the  temporal projection  problem. during phases of continuous behavior  temporal projection is straightforwardly solved by differential calculus. the equations describing a system together with the values of variables can be solved to determine future behavior. difficulties may arise when a discrete action occurs - a single discrete change may cascade through equations and other constraints  resulting in discontinuities in the values of many other continuous quantities. for example  dumping hot water into a container holding some cold water results in discontinu-
ous changes in the mass of water  its level  temperature  pressure at the bottom  and so on. it does not  however  change the specific heat of the water  the location of the pot  its color  and so on. in the circuit of figure 1  opening the relay may cause discontinuous changes in the values of the current and voltage at various points in the circuit  but not in the charge level of the battery. 
　what we are faced with is a special case of the problem of retaining predications across an action  which has been widely studied in the ai literature. there are two basic approaches: either explicit frame axioms are required to carry predications across discrete changes  e.g.  strips  fikes and nilsson  1    or the logic is extended with some sort of accessibility relation and preference relation between possible worlds  e.g.  actionaugmented envisionment  forbus  1  or any of the non-monotonic logics for expressing action . unfortunately  neither approach is altogether satisfactory. providing explicit frame axioms is error-prone and difficult because the frame axioms cannot be specified for individual actions or predicates in isolation. providing an accessibility and preference relation that eliminates implausible consequences  but not plausible ones  while being computationally tractable remains elusive. furthermore  as forbus points out in  forbus  1   there is no formal standard for correctness here; there are only informal desiderata. the primary one is that changes should be minimal and causally related to the action. in the case of predicting behavior of hybrid systems  combinations of the two approaches appear to be quite promising. 
　the device modeling environment  dme   iwasaki and low  1  combines explicit frame axioms with a preference relation. dme uses an algorithm for temporal projection over discrete changes that appears reasonably efficiently and avoids implausible consequences. dme is a modeling and simulation program for hybrid systems where continuous changes are described by a set of algebraic and ordinary time differential equations and discrete changes are described by actions as discussed throughout this paper. when a discrete change takes place  dme prefers among all the states that can result from the action those states that satisfy the following criteria: 
1. the consequence of the action is true in the state. 
1. the values of a variable that is exogenous  inte-grated  or discrete remains the same unless the variable is explicitly changed by the action. 
1. the values of the variables that are specified not to change across discrete changes in user-provided  domain-specific frame axioms remain the same. 
　integrated variables are those quantities whose values at time t is the integration of changes up to that time; unless changed explicitly  their values should not change instantaneously. likewise  exogenous variables are those controlled by entities external to the model; unless changed explicitly  their values are not likely to change. finally  since d m e assumes that all mechanisms for change  continuous or discrete  are represented as equations or actions  and continuous equations cannot change the value of a discrete variable  the value of such a variable is likely to remain the same unless changed explicitly by an action. 
　based on the projected variable values  dme determines what equations should be in effect and recomputes the values of all other variables using the equations. this may or may not result in discrete changes in the values of recomputed variables. if there is not enough information to complete the state description after projecting values from the previous state  the behavior prediction will branch and d m e will produce all possible successor states. dme also allows the user to specify explicitly what quantities can be projected over discrete changes  since the user or the model builder often has knowledge that allows her to provide such domain-specific frame axioms a priori. this strategy avoids producing inconsistencies by being conservative about value projection while allowing improved efficiency when domain-specific frame axioms are available. 
1 	a logic for hybrid systems 
section 1 has defined a model of hybrid systems based on nonstandard analysis that satisfies the desiderata outlined in the introduction. this model may be employed in several ways. it may be embedded into first order logic. a common method for representing actions and change in first order logic is to take time-varying predicates and augment them with an additional argument that ranges over the times that the predicate holds. this argument may be allowed to range over the hyperreals instead of the reals. if the mathematical definitions of continuity  etc.  over the hyperreals are added  then one can reason about the behavior of systems so described. it is often desirable  however  to construct a slightly restricted logic that will enforce the common idioms and 
	iwasaki  etal 	1 
allow them to be more succinctly expressed. for example  temporal logics typically prevent explicit reference to and quantification over time  as well as making temporal statements much more succinct. it is possible to define a temporal logic similar to henzinger's hibrid temporal logic  alur et a/.  1   and replace the real line with hyperreals. we will pursue yet another possibility here and construct a logic specifically for the purpose of predicting and analyzing the behavior of hybrid systems. the key idea is that the denotation of sentences will be given by possible temporal behaviors where time can take on hyperreal values. 
　our logic is based on the approach of concurrent constraint programming  saraswat  1 . concurrent constraint programming uses the idea of a store as the set of possible values of the variables. programs can then add constraints to the store  and ask the store if some constraints are valid. 
　our language modifies the standard concurrent constraint languages  which are atemporal  by allowing the language constructs to extend across time. thus  the store also varies over time. the language is built over a constraint system  and we assume that the constraint system is powerful enough to express the desired properties. in particular  the constraint system can express differential equations and propositional logic. 
the syntax of the language is: 

c represents the constraint being added to the store. we will assume that it stays there until a discrete action adds its negation to the store. d : c =  a is used to represent simultaneous actions  for example those in figure 1  d is the name of the constraint . d ; c - e a represents a discrete action  so a holds an t time after c becomes true.1  a b  is used to put together several such constructs to form a program  first c is used to specify that c is true at the start of an interval. 
　the model we have for these programs is a set of functions from the hyperreals to sets of constraints. each such function represents a possible evolution of a program  describing the constraints that are present in the store at any time instant. the only restriction that we place on these sets of functions is that they be determinate. that is  for any evolution o up to time t  the set {f t  | / extends o  is closed under greatest lower bounds. this enables us to determine uniquely the output of a process given as a set of functions. 


and so on. this gives us all the information we need about the process  and we can use it to deduce various things as shown below. 
　once we have a denotational mode  for our programs  we immediately get a logic for the language. given programs a b we say   that is every possible evolution of a is a possible evolution of b. we then build up an inference system for this logic1. we can use this logic to reason about programs. for example  if b is known never to get into a bad state  and  then we know that a can never get into a bad state. thus  in the above example we can prove that  which might be a desired safety property. 
　the language described here is  of course  not a fullfledged modeling language. it does not provide a succinct way of characterizing temporal evolution using defaults such as tcc  saraswat et a/.  1   nor does it provide a succinct syntax for describing physical systems and the processes that effect them such as the cml  falkenhainer et a/.  1 . however  it does illustrate the basic ideas described in this paper. 
1 	related work 
there has been a considerable amount of work that ad-
　
1 	qualitative reasoning and diagnosis 
　
dresses the problems of reasoning about hybrid systems or has looked at the issues of using nonstandard analysis to represent processes acting at different orders of magnitude. 
　hybrid temporal logic  htl   alur et al  1  allows the behavior of piecewise-continuous systems to be described and enables properties of these behaviors to be verified  by hand . this work uses a real model of time together with limits to describe discontinuities. htl 
1  see  saraswat et al.  1  for details. 
　
does not allow for a sequence of actions. the work has been mostly  descriptive   rather than  predictive . 
　forbus introduced the notion of an  action augmented envisionment   forbus  1  that incorporates discrete instantaneous actions into his qualitative process theory  forbus  1 . it appears likely that this approach is consistent with the representation that we have described. it is difficult to be certain  because there is no commitment to a model of time. 
　there are several limitations of forbus' approach. first  only a single action may occur at a time. forbus observes that this is not a fundamental limitation  as compound actions may be defined. this is  however  an important practical limitation - it makes it impossible to define any action in isolation of others. this may seem palatable when considering actions taken by a single agent  but when there are multiple agents it becomes problematic. second  there cannot be any sequences of actions. third  actions can only change the truth of atomic ground formulae  the strips action model . this means that actions cannot introduce new objects into the system depending on its state. fourth  the algorithms presented to infer the behavior of a system to which actions might be applied do not scale. they effectively apply each action whenever it can be applied to all possible states that the system might ever be in. forbus suggests that incremental algorithms should be possible  but they have not been further developed  although one can view the algorithms described in this paper and implemented in the dme system as incremental algorithms for achieving this purpose. finally  the state that results from applying an action is determined heuristically. the state that results from applying an action is the state that is consistent with the action and most like the one in which the action was applied. in his implementation   most like  means sharing the maximal number of assumptions. there is no place in the representation for explicitly stating frame axioms; they are implicitly defined by the  nearest neighbor  heuristic. 
　nishida and doshita proposed two methods  called approximation and direct methods  to handle discontinuous changes in simulating the behavior of a mostly continuous system  nishida and doshita  1 . the approximation method models a discontinuous jump in a continuous variable value as a gradual change and carries out envisionment of the behavior during the gradual change using infinitesimals. the approximation method works well when discontinuous change occurs in an otherwise continuously valued input variable. however  it is not clear how well the method will perform when a discontinuous change is caused by a mode transition  positive feedback without time delay  or a change in the value of a discrete-valued variable. 
　the direct method predicts a sequence of mythical instantaneous states between normal states when a discontinuous change takes place. the mythical instances are states where the variables do not satisfy all the system constraints. the method produces a series of mythical states as it searches for a consistent state by relaxing assumptions that cause inconsistencies one by one. this method seems to predict correctly the consequences of discrete changes while producing a causal account of what happens when such discrete changes take place for any types of discrete changes. de kleer and brown also use the notion of mythical states to produce a causal account of how disturbances propagate through a model to cause a change  though they do not handle discrete changes  de kleer and brown  1 . the problem with the notion of  mythical  states in both cases is that it is not clear what they actually represent. in other words  it is not clear whether mythical states represent very short but real instances or are an artifact of the representation and reasoning procedures. if they do represent real instances  the semantics of the underlying model of time becomes unclear. 
　raiman used nonstandard analysis as the basis for his theory of order of magnitude reasoning  raiman  1   but his analysis remains within the realm of continuous systems. even though we believe that some types of discontinuous changes can be modeled as continuous changes using order of magnitude reasoning  as nishida and doshita showed  other types of discontinuous changes such as changes in symbolic variables  do not lend themselves easily to this approach. 
　weld has developed a qualitative simulation algorithm based on a nonstandard model of time and quantities in detail  weld  1 . the motivation for his work is to answer comparative analysis questions about the behavior of dynamic systems by changing the value of a model parameter to an extreme  infinite or an infinitesimal  value and simulating the behavior. davis has also developed a theory that combines order of magnitude reasoning and envisionment of qualitative differential equations based on nonstandard analysis  davis  1 . davis' motivation is to reason about the behavior of dynamic systems containing parameters of widely ranging magnitudes. whereas weld's formulation allows derivatives to have nonstandard magnitudes  including infinite and infinitesimal   we define derivatives to be standard numbers  following the definitions in several textbooks on nonstandard analysis  e.g.   hoskins  1  . despite this difference  our formulation seems generally consistent with those of weld and davis. this paper explores another use of the nonstandard model - analysis of hybrid systems. it is interesting to note that weld and davis resort to nonstandard analysis in order to reason explicitly about infinitesimal  and infinite  values  while we do so in order to ignore infinitesimal differences. 
1 	conclusion 
while hybrid systems have become evermore commonplace  analysis methods have failed to keep pace and have focussed on either  piecewise  continuous or discrete systems. a contributing factor has been the lack of an adequate model for the behavior of hybrid systems. we have shown that approaches in which time is modeled by the real number line fail to satisfy key desiderata. fortunately  we have also shown that an approach in which 
	iwasak1  et al. 	1 
time is modeled by the hyperreal line can satisfy these desiderata. our model for hybrid systems supports: 
  discrete actions occurring in the presence of con-tinuous change. continuity is well defined on the hyperreal line and the standard part of the value of a continuous function is unchanged across any infinitesimal interval. thus  values can be projected across actions without introducing any contradictions. 
  complex sequences of discrete actions. arbitrary finite sequences of actions may occur in our model. 
  the abstraction that discrete actions are instanta-neous. a real valued continuous clock cannot measure the infinitesimal duration of a sequence of actions. 
furthermore  our model allows actions to take different amounts of time before their consequences take effect  e.g. one action can be twice as fast as another . 
　we have used our model in two ways: to provide a semantics for dme's algorithm for predicting behavior of hybrid systems  and to define a simple logic for the prediction and analysis of behavior. we are working to extend the logic to support defaults and the properties necessary to succinctly solve the temporal projection problem. this will enable us to provide a clean compositional semantics for rich device modeling languages such as cml  falkenhainer et ai  1  and  with appropriate computational support  allow for properties of hybrid systems to be verified. 
