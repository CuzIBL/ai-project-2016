 
we present a model-based monitoring method for dynamic systems that exhibit both discrete and continuous behaviors. mimic  dvorak and kuipers  1  uses qualitative and semiquantitative models to monitor dynamic systems even with incomplete knowledge. recent advances have improved the quality of semi-quantitative behavior predictions  used observations to refine static envelopes around monotonic functions  and provided a semiquantitative system identification method. using these  we reformulate and extend mimic to handle discontinuous changes between models. each hypothesis being monitored is embodied as a tracker  which uses the observation stream to refine its behavioral predictions  its underlying model  and the time uncertainty of any discontinuous transitions. keywords: model-based monitoring; model refinement  hybrid systems 
1 	introduction 
physical systems are by nature continuous. however  it is natural to simplify models by abstracting isolated regions of rapid change to instantaneous discontinuities separating regions of continuous behavior  iwasaki et a/.  1; nishida and doshita  1 . systems which exhibit both continuous and discrete behaviors are called hybrid systems  where a continuous segment of the system's be-
havior is called a mode of operation and a discontinuous change is called a transition between modes. 
1 	qualitative reasoning and diagnosis 　model-based monitoring relies on a comparison between the predicted behavior of a model and the observed behavior of a physical system. traditional monitoring approaches typically use a single precise model of the physical system. however  even if the system is behaving properly  precise parameter values and functional relationships are often not known. more importantly  monitoring systems are designed to detect unexpected events or faults  after which knowledge of the system is by definition incomplete. a reliance on precise models leads to overly-specific predictions  sacrificing accuracy and coverage exactly when it is most important for the monitoring system to consider all possible scenarios. 
　the mimic framework  dvorak and kuipers  1  addresses this need  first by using qualitative and semiquantitative  sq  models in the qsim representation  kuipers  1  to express incomplete knowledge with a guarantee that all possible real-valued behaviors are covered; and second  by tracking multiple qualitativelydistinct hypotheses in parallel. sqsim  kay  1  extends the semi-quantitative inference power of qsim by deriving and reasoning with dynamic envelopes guaranteed to bound the real behaviors consistent with an sq model squid  kay  1; kay et a/.  1  is a semi-quantitative system identification method based on sqsim that assimilates a set of observations to an sq model over a single continuous mode. 
　time uncertainty at a mode transition has a particularly explosive effect on the uncertainty of predictions from the sq model after the transition. therefore  we focus our attention first on getting the most out of squidbased tracking of a continuous mode hypothesis  and second  on detecting the mode transition and refining its time uncertainty. in our approach  the monitoring system starts with a coarse description of the physical system and uses the observation stream to refine the behavior prediction  its underlying model  and the time uncertainty of any discontinuous transition. after presenting the details of our extension and reformulation of mimic  we present a non-trivial example and discuss related work. 
1 	tracking piecewise continuous behaviors 
a tracker embodies a continuous mode hypothesis and confirms or refutes the hypothesis by unifying its predictions with the observed behavior. when the observations provide sufficient new information  the tracker may be able to refine the imprecision in the underlying model  and thus make more precise predictions in the future. 
1 	sq system identification 
a tracker is based on squid  kay et a/.  1   which refines an imprecise model  sqde  by a process called 


figure 1: trend matching compares the prediction and the observation corresponding to the level of detail in the behavior prediction derived by sqsim  qualitative  segment and dynamic envelope description . trends describe the observed data at the same levels. 
trend matching. imprecision in the sqde is represented 
by numerical intervals bounding possible values of unknown parameters  and by static envelopes - functions bounding the possible graphs of unknown monotonic functions. 
　trend matching compares semi-quantitative trajectory descriptions derived by sqsim  the sq prediction  and the corresponding properties of the observations  the sq trend . to refine the underlying model  portions of the model space which cannot plausibly generate the observations are excluded. 
　there are three levels of abstracted properties of the trajectories  corresponding to the level of detail derived by the components of sqsim: qualitative  qsim   segment  q1   and dynamic envelope  nsim  descriptions  figure 1 . the qualitative description is defined by a sequence of symbols  representing the deriva-
tive's sign  qdir  of the trajectory at time points and intervals between time points. the segment description specifies intervals bounding the trajectory at particular time points  i.e.  magnitude and time ranges. the dynamic envelope description bounds the trajectory by a 
lower and an upper envelope. a trend represents the abstracted properties of the observed data  figure 1   i.e.  symbols representing the qdir  bounding intervals on extrema and bounding envelopes for monotonic segments. 

figure 1: tracker architecture. 
1 	tracker architecture 
figure 1 presents the architecture of a tracker. the tracker is initialized with the sq prediction and the underlying sqde of the current mode. information about the time boundary and the time uncertainty of the current mode may be given. the tracker consumes an observation stream and it either produces a refined sq prediction and sqde  or detects a discrepancy between the observation and the prediction. the observation stream is a sequence of samples: numeric values for variables at specified times derived by possibly noisy sensors. samples do not necessarily appear at a constant rate  and need not be synchronized across variables. 
　trend forming generates an sq trend describing each variable in the observation stream by breaking the samples into monotonic segments  kay et o/.  1 . the segments are determined by computing the slope of a linear least-squares fit to the data within a sliding window over the samples. dynamic envelope descriptions for the t and i segments are generated by msquid  a neural network-based estimator for monotonic functions  kay and ungar  1; 1   out to any given confidence bound. each 1 segment is described by the segment's time interval and the minimum and maximum sample values over that interval. 
　the goal is to detect the qualitative dynamics of the underlying signal in the noisy observation. in the current implementation it is assumed that gaussian noise of fixed mean and variance is superimposed on the  pure  signal. each observed variable has an error model that specifies bounds on mean and variance for noise. 
　trend mapping compares the sq trend derived from the observations with the sq prediction by stepping through both sequences. if an inconsistency is detected between the trend and the prediction  the current hypothesis is refuted  so the mapping process and the current tracker are aborted. 
	rinner and kuipers 	1 

qualitative mapping generates a correspondence between the qdirs in the sq prediction and the sq trend. a successful correspondence may fail to be one-to-one because  i  the samples in the observation stream may end before some of the qualitative changes in the sq prediction take place;  ii  the sq prediction terminates with a mode change before the end of the current sq trend  leaving data to correspond to the next mode; or  iii  the sq prediction may include small qdir changes which are not detectable in a noisy observation stream. 
segment mapping ensures consistency of corresponding behavior segments in the sq trend and the sq prediction  in the sense that their time and magnitude bounds overlap. consistency of segments is checked by asserting the segment bounds of the sq trend to the corresponding segments of the sq prediction and propagating these bounds to the other variables in the sqde using q1's interval propagation  kuipers  1 . 
dynamic envelope mapping ensures consistency by intersecting the dynamic envelopes for corresponding monotonic segments of the trend and the prediction. 
　model refinement takes place when trend mapping decreases the bounds on some variables in the sqde. parameter imprecision is refined by using q1 to derive bounds on independent variables from dependent ones. q1 propagates intervals across model variables at time points and uses the  weak  mean value theorem to propagate those bounds over time intervals. the dynamic envelopes in the sq trend provide more information than just magnitude and time bounds over monotonic segments. model refinement exploits this information by introducing several instantaneous  snapshots  over the monotonic trend segments and propagating the smaller magnitude bounds at these time instants to other model variables. the number of  snapshots  affects the achieved refinement and is specified by the user. functional imprecision is refined by excluding portions from the static envelopes that are inconsistent with the  refined  variable bounds. the trend matching techniques guarantee that portions of the model space are ruled out only when they are inconsistent with the observations  kay et al  1 . 
　if a mode change is manifested by a discontinuous change of an observed variable or a sudden sign change of its slope  the change becomes explicit in the purely qualitative trend  and is easy to detect. otherwise  segment and dynamic envelope trend mapping should eventually refute the current model  but excessive imprecision in the model and uncertainty in the data could prevent the change from being recognized. 
　once a mode change has been detected  the tracker for the next mode is initialized with the variable values at the transition point. the new tracker attempts to create a mapping between its sq prediction and the remaining segments of the observed trend. time uncertainty in the mode change affects the current tracker and more 1 qualitative reasoning and diagnosis dramatically the following tracker  in an important way. 
1 refining the time uncertainty of discontinuous changes 
we assume that there are three possible causes for discontinuous changes in the model of a complex system:  i  the autonomous operation of the plant moves from one operating mode to another;  ii  the plant operator takes a known action; and  iii  an unexpected and externally caused event such as a failure takes place. in the first two cases  the current and following modes are known. in the third case  we assume that a separate diagnosis engine proposes a set of fault hypotheses  which mimic tracks in parallel. 
　a discontinuous change happens in an instant. unfortunately  with imprecise models and noisy and finitely sampled observations  we may never be able to determine the precise instant when the change takes place. the best we can do is determine time bounds on the instant when the change occurred. 
　for matching a piecewise continuous model to a stream of observations  it is particularly important to make the time bounds on discontinuous changes as precise as possible. time uncertainty on a mode change affects the entire correspondence between prediction and observation in the following mode  resulting in propagating uncertainty. figure 1 c  shows how weak time bounds on a discontinuous change can result in extremely weak bounds on the prediction of the following mode. therefore  we focus on improving these time bounds. 
1 	intersecting trend and prediction 
we focus here on refining time uncertainty of a mode change based on the intersection of sq trend and sq prediction. after semi-quantitative reasoning has provided bounds on the transition time  advanced filtering techniques based on statistical or digital signal processing may be applicable. 
　when there is time uncertainty  the mapping between the sq trend and the sq prediction is not fixed. the sq prediction can be shifted relative to the sq trend by any offset within the range of the time uncertainty. 
　however  a mapping is only valid if the sq trend segment and the sq prediction segment have a non-empty intersection for every time-point t in the sq trend. this is exploited to derive refined bounds on the time uncertainty of discontinuous changes  figure 1 . 
　　for | segments  the mapping is valid as long as  i  the upper envelope of the trend is above the lower envelope of the prediction and  ii  the lower envelope of the trend is below the upper envelope of the prediction. more formally  we can determine the lower bound and the upper bound respectively  as follows: 


figure 1: deriving bounds on the time uncertainty by intersecting the sq prediction and the sq trend. 
1 refine-transition tu  mode -  modej  sqtrend  
1 behs  - generate-behaviors modej  
1 for each behavior beh in behs do 
1 t  - t u 
1 repeat 
1 refine 1- false 
1 tn  - intersect beh  sqtrend  
1 if  t n = 1  then 
1 refute beh 
1 elseif  t n   t  then 
1 t  - t n 
1 refine  ~ true 
1 re-assign samples to modei and mode  
1 re-track mode  
1 inherit refinements from modei to beh 
1 endif 
1 until not  refine  
1 endfor 
figure 1: incremental refinement of the initial time uncertainty tu between modei and modej. 

where  i s the observed trend 	 s 
the prediction  shifted by   over- and under-bars represent the upper and lower dynamic envelopes  respectively. similar conditions hold for and segments. 
　this intersection process is applied to all segments of the mode. improvements in time uncertainty propagate from segment to segment by interval arithmetic and intersection of bounding intervals. 
1 	incremental refinement 
when there is a great deal of time uncertainty about the transition from one mode to another  many samples in the observation stream fall within the uncertainty interval  and thus cannot be unambiguously assigned to one of the adjacent segments of monotonic change. after time uncertainty is decreased  some samples can now be assigned to a definite adjacent segment. the additional information helps refine the mode the segment belongs to  and its underlying model. improvements to the adjacent modes can  in turn  lead to further decreases in time uncertainty of the transition. and so on until no further improvement results. 
　the algorithm for incremental refinement of the time uncertainty between two adjacent modes i and j is presented in figure 1. the trend/prediction intersection  line 1  is performed for each behavior in the succeeding mode. if the trend is inconsistent with the behavior at the qualitative level or no valid mapping can be found for any time offset within the time uncertainty the behavior is refuted  line 1 . since each behavior is independently intersected with the trend this method results in different refinements on the uncertainty interval for each behavior of the succeeding mode. 
1 	overall monitoring system 
the overall monitoring system tracks multiple hypotheses in parallel. the hypotheses may represent different nominal or fault models of the plant  or they may represent different qualitative behaviors predicted from semiquantitative simulation of a particular model. 
　a particular hypothesis is a sequence of mode hypotheses  the monitoring system alternates between tracking a particular mode hypothesis   and refining the time uncertainty of the mode transition at  several trackers and their hypotheses may be refined in parallel  figure 1 . the achieved refinements  sq prediction and sqde  are passed to the tracker manager which instantiates new trackers and refines the time uncertainty of the mode transition. as discussed in section 1  we assume that the models for new modes are known. information from the observation stream  such as the satisfaction of a condition that autonomously moves the system to another mode or a signal indicating an operator action  allows the tracker manager to choose the model s  for the new mode. fault models may also be proposed at any time by a separate diagnosis engine. 
　model refinements such as improved variable bounds or static envelopes may be inherited from one model to the next  across a mode transition. in the current implementation  the user specifies the variables and functional relations whose refinements can be inherited. 
　the degree of model precision is important for the fault detection performance of our monitoring system. however  with imprecise models  uncertain observation and limited observability we may never be able to detect all faults or distinguish between every possible hypothesis. in order to achieve a sufficiently precise prediction for fault detection   i  our initial knowledge about the 
	rinner and kuipers 	1 


figure 1: overall monitoring system. 
system must be precise enough or  ii  we must collect enough data from the  healthy  physical system to refine its model to the required degree of precision. 
1 	experimental results 
we demonstrate the refinement capabilities of our monitoring system using a two tank system. in this example  figure 1 a    we start with a filled upper tank and an empty lower tank; the drains of both tanks are open and the upper tank is filled at a constant inflow rate. when the amount in the upper tank drops below a limit the inflow rate is increased. this scenario is modeled as a transition between two operating modes  figure 1 b  . only imprecise information is known about this scenario  i.e.  intervals for variables and bounding envelopes for functional relations. since both tanks remain unchanged  the refinements of the variables o and b as well as of the functional relations / and g are inherited from the first to the second mode. 
　sqsim predicts 1 different behaviors for the two tank scenario; 1 of them include the region transition. only one is consistent with the sq trend; the other trackers are refuted. figure 1 c  shows the predicted dynamic envelopes for the amount in the lower tank for the surviving prediction. sqsim predicts the time of the mode transition as  1  in/ . 
　　the observations are generated by numeric simulation of an ode  adding gaussian noise with fixed mean and variance to the samples. the exact model for deriving the samples is given as 
with  =1  = 1  c = 1 and an inflow rate if a = 1 before and if a = 1 after the transition. the samples are generated at a rate of 1 hz. 
　figure 1 d  shows the samples and bounding envelopes derived by trend forming for the variable 1. msquid 
1 	qualitative reasoning and diagnosis 

table 1: achieved refinements dependent on the observed variables including noise with  = 1 and var = 1. 
constructs the bounding envelopes around the observations to achieve a certainty of 1%. this figure also presents the final refinement achieved by the monitoring system. the dynamic envelopes for- b are refined to 1% of their initial area and the time uncertainty is refined to  1 1  after two iterations of the refinement algorithm1. observations for a  1  of a and of b  with noise  = 1 and var = 1  are used in this case. note the propagation of refinements through the sqde  i.e.  the dynamic envelopes in the first segment are narrower than the bounding envelopes of the observation of 1. due to time uncertainty  the dynamic envelopes in the second mode are wider than the bounding envelopes of the observation. 
　the effect of observability is shown in table 1. this table presents the achieved refinements dependent on the observed variables. the degree of refinement is defined by the ratio of the predicted and refined areas for variables and functional relations. for the variables a and 1  the area is specified by the dynamic envelopes over the observation time. for the functional relations / and g  the area is specified by the bounding functions  static envelopes  over the range of / and g. the achieved refinement of the time uncertainty is represented by tc. as the number of observed variables increases the refinement improves and extends to more variables and functional relations. table 1 presents the reduced refinements caused by an increase of noise in the observation. 
1 	conclusion 
we have presented a method for monitoring dynamic systems that exhibit both discrete and continuous behaviors. the monitoring system refines the behavior prediction  the underlying model and the time uncertainty of discontinuous changes. the hypothesis is refuted and pruned from the tracking set when refinement eliminates all possible values for any parameter. 
trend matching uses a statistical best fit to observed 
l
   in our experiments incremental refinement never required more than 1 iterations; it usually stopped after 1 or 1. 


	 b  imprecise model with mode transition 	 d  refined behavior and time uncertainty 
figure 1: a two tank scenario  a   modeled as an autonomous mode transition  b   its prediction  c  of the upper and lower bounds  dynamic envelopes  for b  and the refined bounds and time uncertainty  d . in both graphs  the solid lines represent the predicted or refined dynamic envelopes. the dotted box represents the time uncertainty of the mode change; the dashed lines represent the bounding envelopes of the observations  d . due to the time uncertainty of the discontinuous change the prediction of the second mode can start at any time within the dashed box. for the sake of readability  they start in the middle  c  and at the right end  d  of the dashed box  respectively. data  plus bounding envelopes out to any desired confi- defined behavior templates no refinement can be per-

dence bound. portions of the model space are removed only when they are inconsistent with these bounds. this gives a good  and adjustable  compromise between aggressiveness and robustness in handling noise and uninformative data. 
related work has been done by  mosterman et a/.  
1 . in their framework for model-based diagnosis the physical system is modeled by a temporal causal graph. qualitative candidate models are derived from this representation and parameter estimation techniques are applied to fit the candidate models to the observation. trendx  haimowitz and kohane  1  is a monitoring system which uses a semi-quantitative representation of a behavior and attempts to fit data to this behavior representation. since trendx uses preformed. pret  bradley and stolle  1  automatically constructs a precise ode model of a physical system. pret focuses on system identification and not on monitoring. loiez and taillibert  loiez and taillibert  1  use piecewise polynomial functions  so-called temporal band sequences  to bound the observation stream. the behavior of components in analog circuits is modeled by sums of temporal functions including derivatives of any order. this approach is only able to detect discrepancies but not to predict the behavior of the system. mcllraith et al.  mcllraith et a/.  1  present an approach for diagnosing hybrid systems where all mode transitions  i.e.  the history of executed actions  are known. candidate generation and model estimation are based on the model-based diagnosis framework of  mosterman et 
	rinner and kuipers 	1 

a/.  1  and the tracker framework is adopted to refine 
multiple candidates. 
　furthermore  our monitoring method is directly applicable to fault diagnosis in dynamic systems. fault hypotheses can be proposed for monitoring based on initial weak information such as the signs of discrepancies between observations and predictions  by using existing methods such as  de kleer and williams  1; ng  1 . automatic model-building methods can select relevant model-fragments from a background knowledge base to express initially weak knowledge about a fault as an sqde  crawford et al  1; rickel and porter  1 . the observation stream is then used to refine or refute each proposed model. 
acknowledgments 
this work has taken place in the qualitative reasoning group at the artificial intelligence laboratory  the university of texas at austin. research of the qualitative reasoning group is supported in part by nsf grants iri-1 and cda 1  by nasa grants ncc 1  nag 1 and 1  and by the texas advanced research program under grants no. 1 and 1. bernhard rinner is supported by the austrian science fund under grant number j1-mat. 
